<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>麥擱騙｜詐騙網址幫你查 - 線上即時檢測工具</title>
    <meta name="description" content="輸入網址，快速檢查是否為詐騙網站、惡意連結或釣魚網頁。支援手機與電腦瀏覽。">
    <link rel="icon" href="https://ik.imagekit.io/mygopen/check_ico.png">
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Noto Sans TC"', 'ui-sans-serif', 'system-ui', 'sans-serif'],
                    },
                    colors: {
                        brand: {
                            red: '#d93025',
                            darkRed: '#b92b1b',
                            light: '#fff1f0',
                            green: '#188038', 
                            darkGreen: '#12662d'
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.6s ease-out forwards',
                        'slide-up': 'slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { opacity: '0', transform: 'translateY(20px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    },
                    boxShadow: {
                        'soft': '0 10px 40px -10px rgba(0,0,0,0.08)',
                        'glow': '0 0 20px rgba(217, 48, 37, 0.3)'
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #f8fafc;
            background-image: 
                radial-gradient(at 0% 0%, rgba(217, 48, 37, 0.03) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(37, 99, 235, 0.03) 0px, transparent 50%);
            background-attachment: fixed;
            -webkit-tap-highlight-color: transparent;
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }
    </style>
</head>
<body class="text-gray-700 antialiased min-h-screen flex flex-col">

    <div id="root" class="flex-grow flex flex-col"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Icons ---
        const IconBase = ({ children, size = 20, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {children}
            </svg>
        );

        const Shield = (p) => <IconBase {...p}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" /></IconBase>;
        const Search = (p) => <IconBase {...p}><circle cx="11" cy="11" r="8" /><line x1="21" y1="21" x2="16.65" y2="16.65" /></IconBase>;
        const Activity = (p) => <IconBase {...p}><polyline points="22 12 18 12 15 21 9 3 6 12 2 12" /></IconBase>;
        const Edit = (p) => <IconBase {...p}><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></IconBase>;
        const BarChart = (p) => <IconBase {...p}><line x1="18" y1="20" x2="18" y2="10" /><line x1="12" y1="20" x2="12" y2="4" /><line x1="6" y1="20" x2="6" y2="14" /></IconBase>;

        // --- Logic Helpers ---
        const withTimeout = (promise, ms, fallbackValue) => {
            return Promise.race([
                promise,
                new Promise(resolve => setTimeout(() => resolve(fallbackValue), ms))
            ]);
        };

        const fetchGeoLocation = async (ip) => {
            try {
                const geoRes = await fetch(`https://ipwho.is/${ip}`);
                const geoData = await geoRes.json();
                if (!geoData.success) throw new Error('Geo failed');
                return { country: `${geoData.country} (${geoData.country_code})`, isReal: true };
            } catch (err) { return null; }
        };

        const checkSiteAvailability = async (fullUrl) => {
            const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(fullUrl)}&disableCache=true`;
            try {
                const res = await fetch(proxyUrl);
                if (!res.ok) return { status: 'unknown', msg: '無法檢測網站狀態' };
                const data = await res.json();
                if (data.status && data.status.http_code >= 400) {
                     return { status: 'error', msg: `網站無法正常存取 (HTTP ${data.status.http_code})` };
                }
                const text = data.contents || "";
                if (text.length < 500) return { status: 'blank', msg: '網站可視內容過少 (高風險偽裝特徵)' };
                return { status: 'ok', msg: '網站運作正常' };
            } catch (e) { return { status: 'unknown', msg: '無法檢測網站內容' }; }
        };

        const checkTrancoRank = async (domain) => {
            try {
                const res = await fetch(`https://corsproxy.io/?${encodeURIComponent(`https://tranco-list.eu/api/ranks/domain/${domain}`)}`);
                if (!res.ok) return null;
                const data = await res.json();
                return (data.ranks && data.ranks.length > 0) ? data.ranks[0].rank : null;
            } catch (e) { return null; }
        };

        const fetchRDAPData = async (domain) => {
            try {
                const res = await fetch(`/api/rdap?domain=${domain}`);
                if (!res.ok) return { date: null };
                const data = await res.json();
                const events = data.events || [];
                let regEvent = events.find(e => e.eventAction === 'registration') || events.find(e => e.eventAction === 'created');
                return { date: (regEvent && regEvent.eventDate) ? regEvent.eventDate : null };
            } catch (e) { return { date: null }; }
        };

        const fetchTraceData = async (url) => {
            try {
                const res = await fetch(`/api/trace?url=${encodeURIComponent(url)}`);
                return res.ok ? await res.json() : null;
            } catch (e) { return null; }
        };

        const checkCommunityBlocklists = async (domain) => {
            try {
                const sources = [
                    'https://cdn.jsdelivr.net/gh/houboyjacky/Ad-Malicious-Scams-Boring-Farm-Filter@master/ScamsSiteGetFromFB_TonyNey.txt',
                    'https://danny0838.github.io/content-farm-terminator/files/blocklist-ublacklist/scam-sites.txt'
                ];
                const contents = await Promise.all(sources.map(url => fetch(url).then(res => res.ok ? res.text() : '')));
                return contents.join('\n').toLowerCase().includes(domain.toLowerCase());
            } catch (e) { return false; }
        };

        // --- Core Scan Logic ---
        const simulateScan = async (targetDomain, fullUrl, whitelist) => {
            let resolvedIp = null;
            try {
                const dnsRes = await fetch(`https://dns.google/resolve?name=${targetDomain}&type=A`);
                const dnsData = await dnsRes.json();
                if (dnsData.Answer) resolvedIp = dnsData.Answer.find(r => r.type === 1)?.data;
            } catch(e) {}

            const domain = targetDomain.toLowerCase();
            const highRiskSuffixes = ['.shop', '.xyz', '.top', '.live', '.site', '.cn'];
            const isVeryHighRiskTLD = highRiskSuffixes.some(s => domain.endsWith(s));
            
            // 使用動態載入的白名單進行檢查
            const isWhitelisted = whitelist.some(w => domain.endsWith(w));

            const [geoLocationData, siteStatusData, blocklistListed, trancoRank, rdapData, traceData] = await Promise.all([
                withTimeout(resolvedIp ? fetchGeoLocation(resolvedIp) : Promise.resolve(null), 2000, null),
                isWhitelisted ? Promise.resolve({ status: 'ok', msg: '白名單網站' }) : withTimeout(checkSiteAvailability(fullUrl), 5000, { status: 'unknown', msg: '檢測逾時' }),
                withTimeout(checkCommunityBlocklists(domain), 4000, false),
                withTimeout(checkTrancoRank(domain), 3000, null),
                withTimeout(fetchRDAPData(domain), 4000, { date: null }), 
                withTimeout(fetchTraceData(fullUrl), 8000, null)
            ]);

            const isHighTraffic = (trancoRank !== null || isWhitelisted);
            let riskScore = 0;
            if (blocklistListed) riskScore = 100;
            else {
                if (siteStatusData.status === 'blank') riskScore += 90;
                if (isVeryHighRiskTLD) riskScore += 40;
                if (traceData?.isHighRisk) riskScore += 40;
                if (isWhitelisted) riskScore = 0;
            }

            let ageDetails = '無法獲取', ageStatus = 'unknown';
            if (rdapData.date) {
                const diffDays = Math.ceil(Math.abs(new Date() - new Date(rdapData.date)) / (1000 * 60 * 60 * 24));
                ageDetails = `註冊日期: ${rdapData.date.split('T')[0]} (約 ${(diffDays/365).toFixed(1)} 年前)`;
                ageStatus = diffDays < 180 ? 'danger' : 'safe';
            }

            return {
                domain, scannedUrl: fullUrl, traceChain: traceData?.chain || [], riskScore: Math.min(100, riskScore), blocklistListed,
                details: { serverCountry: geoLocationData?.country || '無法偵測' },
                checks: {
                    siteContent: { status: siteStatusData.status === 'ok' ? 'safe' : 'danger', label: '網站內容', details: siteStatusData.msg },
                    traffic: { status: isHighTraffic ? 'safe' : 'warning', label: '流量排名', details: isHighTraffic ? '受信賴的熱門網域' : '全球排名較低' },
                    age: { status: ageStatus, label: '註冊時間', details: ageDetails }
                }
            };
        };

        // --- UI Components ---
        const RiskMeter = ({ score }) => (
            <div className="mt-4 mb-6">
                <div className="flex justify-between mb-1 text-sm font-bold"><span>安全</span><span className={score >= 70 ? 'text-red-600' : 'text-green-600'}>{score >= 70 ? '高度風險' : '低度風險'}</span><span>危險</span></div>
                <div className="h-3 w-full bg-gray-200 rounded-full overflow-hidden"><div className={`h-full ${score >= 70 ? 'bg-red-600' : 'bg-green-500'} transition-all duration-1000`} style={{ width: `${Math.max(10, score)}%` }}></div></div>
            </div>
        );

        const TraceTimeline = ({ chain }) => {
            if (!chain || chain.length <= 1) return null;
            return (
                <div className="bg-white rounded-2xl border border-gray-100 overflow-hidden mb-6 shadow-sm">
                    <div className="bg-gray-50/80 px-6 py-4 border-b border-gray-100 flex items-center gap-2"><Activity size={20} className="text-brand-red" /><h3 className="font-bold text-gray-800">跳轉路徑</h3></div>
                    <div className="p-6 space-y-4">
                        {chain.map((hop, i) => (
                            <div key={i} className="flex items-start gap-4">
                                <div className={`w-3 h-3 rounded-full mt-1.5 flex-shrink-0 ${hop.status >= 300 ? 'bg-orange-500' : 'bg-green-500'}`}></div>
                                <div className="flex-grow min-w-0"><div className="text-xs font-bold text-gray-400">HTTP {hop.status}</div><div className="font-mono text-xs break-all text-gray-600 bg-gray-50 p-1 rounded">{hop.url}</div></div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const MyGoPenSection = ({ domain }) => (
            <div className="bg-brand-light/50 border border-brand-red/20 rounded-2xl p-6 mt-8">
                <div className="flex items-center gap-3 mb-4"><Shield className="text-brand-red" size={24} /><h3 className="font-bold text-gray-800 text-lg">防詐騙資料庫查詢</h3></div>
                <div className="flex flex-col md:flex-row gap-3">
                    <a href={`https://www.mygopen.com/search?q=${encodeURIComponent(domain)}`} target="_blank" className="flex-1 bg-white border border-brand-red text-brand-red hover:bg-brand-red hover:text-white font-bold py-3 px-4 rounded-xl text-center transition-all">MyGoPen 搜尋</a>
                    <a href={`https://165dashboard.tw/key-word-search?keyWord=${encodeURIComponent(domain)}`} target="_blank" className="flex-1 bg-white border border-blue-500 text-blue-600 hover:bg-blue-500 hover:text-white font-bold py-3 px-4 rounded-xl text-center transition-all">165 打詐儀錶板</a>
                </div>
            </div>
        );

        const App = () => {
            const [url, setUrl] = useState('');
            const [loading, setLoading] = useState(false);
            const [result, setResult] = useState(null);
            const [whitelist, setWhitelist] = useState([]); // 儲存白名單狀態
            const resultRef = useRef(null);

            // 初始化：從 Github 同目錄讀取 whitelist.json
            useEffect(() => {
                fetch('./whitelist.json')
                    .then(res => res.ok ? res.json() : { domains: [] })
                    .then(data => setWhitelist(data.domains || []))
                    .catch(err => console.error("無法載入白名單:", err));
            }, []);

            const handleScan = async (e) => {
                e.preventDefault();
                if (!url.trim()) return;
                let urlToParse = url.trim().startsWith('http') ? url.trim() : 'https://' + url.trim();
                try {
                    const urlObj = new URL(urlToParse);
                    setLoading(true); setResult(null);
                    const data = await simulateScan(urlObj.hostname, urlObj.href, whitelist); // 傳入白名單
                    setResult(data);
                } catch (err) { alert('網址格式錯誤'); } finally { setLoading(false); }
            };

            useEffect(() => { if (result) resultRef.current?.scrollIntoView({ behavior: 'smooth' }); }, [result]);

            return (
                <div className="flex flex-col min-h-screen">
                    <header className="bg-white border-b sticky top-0 z-20 shadow-sm"><div className="max-w-5xl mx-auto px-4 h-16 flex items-center gap-2"><img src="https://ik.imagekit.io/mygopen/menu-logo.png" className="h-8" /><h1 className="font-bold text-gray-800">網址查查</h1></div></header>
                    <main className="flex-grow pt-8 pb-12 px-4 max-w-3xl mx-auto w-full">
                        <div className="text-center mb-10"><h2 className="text-3xl font-extrabold mb-2">遠離詐騙，<span className="text-brand-red">從檢查開始</span></h2><p className="text-gray-500">即時分析網站特徵與黑名單資料庫</p></div>
                        <div className="bg-white rounded-2xl shadow-soft p-3 mb-8 border border-gray-100">
                            <form onSubmit={handleScan} className="flex flex-col md:flex-row gap-2">
                                <input type="text" className="flex-grow px-4 py-4 bg-gray-50 rounded-xl focus:ring-2 focus:ring-brand-red outline-none" placeholder="輸入網址 (如 www.bot.com.tw)" value={url} onChange={e => setUrl(e.target.value)} />
                                <button type="submit" disabled={loading} className="px-8 py-4 bg-brand-red text-white font-bold rounded-xl shadow-glow disabled:bg-gray-400">{loading ? '檢測中...' : '立即檢測'}</button>
                            </form>
                        </div>
                        {result && (
                            <div ref={resultRef} className="animate-slide-up space-y-6">
                                <div className="bg-white rounded-3xl shadow-soft p-6 md:p-8 border border-gray-100">
                                    <div className="mb-6"><div className="text-xs text-gray-400 font-bold uppercase">目標網域</div><h3 className="text-2xl font-bold break-all">{result.domain}</h3></div>
                                    <RiskMeter score={result.riskScore} />
                                    <TraceTimeline chain={result.traceChain} />
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                                        {Object.values(result.checks).map((c, i) => (
                                            <div key={i} className={`p-4 rounded-xl border ${c.status === 'safe' ? 'bg-white' : 'bg-red-50'}`}><div className="font-bold text-sm mb-1">{c.label}</div><div className="text-xs text-gray-600">{c.details}</div></div>
                                        ))}
                                    </div>
                                    <MyGoPenSection domain={result.domain} />
                                </div>
                            </div>
                        )}
                    </main>
                    <footer className="py-6 text-center text-gray-400 text-sm border-t">&copy; {new Date().getFullYear()} MyGoPen 麥擱騙</footer>
                </div>
            );
        };
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
